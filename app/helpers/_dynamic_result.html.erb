<center>
  <table id="dynamic_result_table" style="text-align: center">
    <% if result.first %>
    <tr>
      <%= result.first.attributes.map { |k, _| "<th>#{k}</th>" }.join.html_safe %>
    </tr>
    <% end %>
    <% result.each do |patient| %>
    <tr>
      <%= patient.attributes.map { |_, v| "<td>#{v}</td>" }.join.html_safe %>
    </tr>
    <% end if result %>
  </table>
  
  <button id="table2csv">Download CSV</button>
  
  <script>
    $( function() {
      $( '#dynamic_result_table th' ).each( function(index) {
        $( this ).on( 'click', function() {
          var header = $("#dynamic_result_table tr > th:eq(" + index + ")");
          console.log( header );
          if ( header.text() == '*' ) {
            header.text( header.attr( 'title' ) );
            header.attr( 'title', '' );
            $('#dynamic_result_table tr').find( "td:eq(" + index +")" ).each( function() {
              $( this ).text( $( this ).attr( 'title' ) );
              $( this ).attr( 'title', '' );
            });
          } else {
            header.attr( 'title', header.text() );
            header.text( '*' );
            $('#dynamic_result_table tr').find( "td:eq(" + index +")" ).each( function() {
              $( this ).attr( 'title', $( this ).text() );
              $( this ).text( '' );
            });
          }
        });
      });
    });
  
    var regulateCSVCell = function( cell ) {
      if ( cell.indexOf( ',' ) == -1 ) {
        return cell;
      }
      return '"' + cell + '"';
    };
  
    var ary2CSV = function( ary ) {
      csv = '';
      for( var row in ary ) {
        for( var col in ary[row] ) {
          if ( col == 0 ) {
            csv += regulateCSVCell( ary[row][col] )
          } else {
            csv += ',' + regulateCSVCell( ary[row][col] )
          }
        }
        csv += "\n"
      }
      return csv;
    };
    
    var saveCSV = function( csv ) {
      var href = 'data:application/csv;charset=utf-8,'
      href += encodeURIComponent( csv );
      window.open( href );
    };
  
    $( '#table2csv' ).on( 'click', function() {
      var table = [];
      $( '#dynamic_result_table tr' ).each( function( index ) {
        var row = [];
        $( this ).children().each( function() {
          row.push( $( this ).text() );
        });
        table.push( row );
      });
      
      saveCSV( ary2CSV( table ) );
    });
  </script>
  <% if params[:page] %>
  <table>
    <tr>
      <td><%= link_to '<<',  params.merge(:page => params[:page].to_i > 2 ? params[:page].to_i - 1 : 1) %></td>
      <td><label>Page </label><%= params[:page].to_i > 1 ? params[:page].to_i : 1 %></td>
      <td><%= link_to '>>',  params.merge(:page => params[:page].to_i > 0 ? params[:page].to_i + 1 : 1) %></td>
    </tr>
  </table>
  <% end %>
</center>
